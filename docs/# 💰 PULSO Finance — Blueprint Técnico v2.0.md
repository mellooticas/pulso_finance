# üí∞ PULSO Finance ‚Äî Blueprint T√©cnico v2.0

> Sistema financeiro especializado para redes de √≥ticas. Multi-loja, concilia√ß√£o inteligente (Pix/Cart√£o/Boletos), DRE gerencial, fluxo de caixa projetado, IA de previs√µes/insights e Open Finance. Backend Supabase (Postgres + RLS), frontend Next.js 15.

**Status**: Aprovado para Implementa√ß√£o  
**Vers√£o**: 2.0  
**Data**: Janeiro 2025  
**Autores**: Equipe PULSO Finance

---

## üìë √çndice

1. [Vis√£o Geral](#1-vis√£o-geral)
2. [Arquitetura de Alto N√≠vel](#2-arquitetura-de-alto-n√≠vel)
3. [Decis√µes Arquiteturais (ADRs)](#3-decis√µes-arquiteturais-adrs)
4. [Modelo de Dados](#4-modelo-de-dados)
5. [Dom√≠nios Funcionais](#5-dom√≠nios-funcionais)
6. [Concilia√ß√£o Banc√°ria](#6-concilia√ß√£o-banc√°ria)
7. [IA & Business Intelligence](#7-ia--business-intelligence)
8. [Integra√ß√µes](#8-integra√ß√µes)
9. [Seguran√ßa e Compliance](#9-seguran√ßa-e-compliance)
10. [Extens√µes v2.0](#10-extens√µes-v20)
11. [Compara√ß√£o Competitiva](#11-compara√ß√£o-competitiva)
12. [Diagramas](#12-diagramas)
13. [Estrutura do Projeto](#13-estrutura-do-projeto)

---

## 1) Vis√£o Geral

### 1.1 Nome e Miss√£o

**Nome**: **PULSO Finance**  
**Tagline**: "O batimento do seu caixa em tempo real"  
**Miss√£o**: Controlar e otimizar o fluxo de caixa de redes de √≥ticas com previs√µes inteligentes e decis√µes acion√°veis.

### 1.2 Princ√≠pios de Design

1. **Especializa√ß√£o √ìtica**: Terminologia, fluxos e KPIs espec√≠ficos do setor
2. **Governan√ßa S√©ria**: RLS, trilha de auditoria completa, segrega√ß√£o de fun√ß√µes
3. **Performance**: √çndices estrat√©gicos, views materializadas, P95 < 2s
4. **UX de Poucos Cliques**: CAD (Custo de A√ß√£o Desejada) < 30s
5. **Interoperabilidade**: CSV/API in/out, webhooks, Open Finance
6. **Explainable AI**: Insights sempre com justificativa rastre√°vel

### 1.3 Diferenciadores

| Caracter√≠stica | PULSO Finance | Concorrentes |
|----------------|---------------|--------------|
| **Especializa√ß√£o** | √ìticas (franquia %, comiss√µes lentes) | Gen√©rico |
| **Concilia√ß√£o** | 70%+ autom√°tico (regras + IA) | Manual ou b√°sico |
| **Multi-loja** | Nativo (RLS por loja) | Add-on caro |
| **Open Finance** | Sincroniza√ß√£o autom√°tica | Apenas CSV |
| **Pix Program√°vel** | Pagamentos automatizados | N√£o tem |
| **PULSO Score** | Gamifica√ß√£o 0-100 | N√£o tem |
| **Pre√ßo** | $99-299/m√™s | $125-500/m√™s |

---

## 2) Arquitetura de Alto N√≠vel

### 2.1 Stack Tecnol√≥gico

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          FRONTEND (Vercel)              ‚îÇ
‚îÇ  Next.js 15 (App Router) + React 18    ‚îÇ
‚îÇ  Tailwind + shadcn/ui + TanStack Query ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ HTTPS/JWT
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       BACKEND (Supabase Platform)       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇPostgreSQL‚îÇ  ‚îÇ  Storage ‚îÇ  ‚îÇ  Auth ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   + RLS  ‚îÇ  ‚îÇ (Anexos) ‚îÇ  ‚îÇ  JWT  ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Edge Functions (Deno)          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - Webhooks Pix                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - IA Pareamento                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - Open Finance Sync            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         INTEGRA√á√ïES EXTERNAS            ‚îÇ
‚îÇ  Pix Providers  ‚îÇ  Adquirentes  ‚îÇ  OCR ‚îÇ
‚îÇ  Open Finance   ‚îÇ  WhatsApp     ‚îÇ  LLM ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 Camadas de Responsabilidade

| Camada | Tecnologia | Responsabilidade |
|--------|------------|------------------|
| **Apresenta√ß√£o** | Next.js SSR/CSR | UI, valida√ß√£o client, cache |
| **API** | Supabase PostgREST | CRUD autom√°tico, RLS |
| **L√≥gica de Neg√≥cio** | RPCs (PL/pgSQL) | Regras complexas, transa√ß√µes |
| **Dados** | PostgreSQL 15 | Persist√™ncia, integridade |
| **Jobs** | pg_cron + Edge Functions | Automa√ß√µes, integra√ß√µes |
| **Armazenamento** | Supabase Storage | Anexos (NF, contratos) |
| **Observabilidade** | Sentry + Vercel Analytics | Erros, performance |

### 2.3 Fluxo de Dados Cr√≠tico

```
1. Usu√°rio faz upload de extrato CSV
   ‚Üì
2. Parser identifica banco (BB/Ita√∫/Santander)
   ‚Üì
3. Normaliza√ß√£o ‚Üí INSERT INTO extratos (dedupe por hash)
   ‚Üì
4. Trigger ‚Üí event_bus('EXTRATO.NOVO')
   ‚Üì
5. Edge Function ‚Üí Motor de Concilia√ß√£o
   ‚îú‚îÄ‚Üí Regras determin√≠sticas (70%)
   ‚îú‚îÄ‚Üí IA de pareamento (20%)
   ‚îî‚îÄ‚Üí Pend√™ncias manuais (10%)
   ‚Üì
6. Trigger ‚Üí Atualiza parcelas.status='pago'
   ‚Üì
7. CDC ‚Üí Refresh views materializadas
   ‚Üì
8. WebSocket ‚Üí Atualiza dashboard em tempo real
```

---

## 3) Decis√µes Arquiteturais (ADRs)

### ADR-001: Backend - Supabase vs. Alternativas

**Status**: ‚úÖ Aprovado  
**Decis√£o**: Supabase (Postgres + RLS + Edge Functions)

**Alternativas Avaliadas**:

| Solu√ß√£o | Pr√≥s | Contras | Score |
|---------|------|---------|-------|
| **Supabase** | ‚úÖ Postgres (finan√ßas), RLS nativo, $25/m√™s | ‚ö†Ô∏è Vendor lock-in moderado | 9/10 |
| Firebase | ‚úÖ Maduro, Google Cloud | ‚ùå NoSQL (ruim p/ finan√ßas) | 5/10 |
| Backend Custom | ‚úÖ Controle total | ‚ùå 3x tempo dev, infra complexa | 6/10 |
| AWS Amplify | ‚úÖ Integra√ß√£o AWS | ‚ùå DX ruim, caro | 4/10 |

**Justificativa**:
- Postgres √© **mandat√≥rio** para integridade referencial financeira
- RLS elimina 90% dos bugs de autoriza√ß√£o multi-tenant
- Edge Functions (Deno) para webhooks sem gerenciar servidores
- Custo previs√≠vel: $25/m√™s at√© 50 lojas

**Trade-offs Aceitos**:
- ‚ö†Ô∏è Vendor lock-in: mitigado por usar SQL padr√£o (migr√°vel)
- ‚ö†Ô∏è Menos controle: aceit√°vel para MVP

---

### ADR-002: Frontend - Next.js 15 (App Router)

**Status**: ‚úÖ Aprovado  
**Decis√£o**: Next.js 15 com App Router (Server Components)

**Alternativas Avaliadas**:

| Solu√ß√£o | Pr√≥s | Contras | Score |
|---------|------|---------|-------|
| **Next.js 15** | ‚úÖ Server Components, Vercel, shadcn/ui | ‚ö†Ô∏è Curva aprendizado | 9/10 |
| Remix | ‚úÖ Web-first, nested routes | ‚ùå Ecossistema menor | 7/10 |
| SvelteKit | ‚úÖ Performance, bundle pequeno | ‚ùå Time React | 6/10 |
| Vite+React SPA | ‚úÖ Simples | ‚ùå Sem SSR | 5/10 |

**Justificativa**:
- Server Components = dashboards r√°pidos (fetch no servidor)
- Vercel = deploy autom√°tico + Edge Functions gr√°tis
- shadcn/ui = componentes prontos e customiz√°veis
- Maior ecossistema React

---

### ADR-003: Concilia√ß√£o - Motor H√≠brido (Regras + IA)

**Status**: ‚úÖ Aprovado  
**Decis√£o**: 3 camadas - Regras (70%) ‚Üí IA (20%) ‚Üí Manual (10%)

**Alternativas Avaliadas**:

| Abordagem | Pr√≥s | Contras | Score |
|-----------|------|---------|-------|
| **H√≠brido** | ‚úÖ Custo-benef√≠cio, escal√°vel | ‚ö†Ô∏è Complexidade m√©dia | 9/10 |
| Apenas Regras | ‚úÖ Simples | ‚ùå Auto-match < 60% | 6/10 |
| Apenas IA | ‚úÖ Potencial 85%+ | ‚ùå Custo alto, dados | 5/10 |
| Terceirizado (Plaid) | ‚úÖ Pronto | ‚ùå $0.25-1/transa√ß√£o | 3/10 |

**Justificativa**:
- Regras cobrem casos √≥bvios (doc_ref, Pix txid) = 70% sem custo
- IA trata edge cases = 20% adicional
- Manual para exce√ß√µes = 10% aceit√°vel
- Feedback loop: aprende com decis√µes manuais

**Implementa√ß√£o Faseada**:
- Sprint 3: Regras (meta 40-50%)
- Sprint 5: IA simples (meta 60-70%)
- P√≥s-MVP: IA avan√ßada (meta 80%+)

---

### ADR-004: Autentica√ß√£o - Supabase Auth + RLS

**Status**: ‚úÖ Aprovado  
**Decis√£o**: Supabase Auth (JWT) + Row Level Security

**Justificativa**:
- RLS = seguran√ßa a n√≠vel de **linha** (usu√°rio s√≥ v√™ suas lojas)
- Auditoria autom√°tica (auth.uid() em triggers)
- MFA nativo, OAuth providers
- Zero custo adicional

**Trade-offs Aceitos**:
- ‚ö†Ô∏è RLS pode degradar performance: mitigado por √≠ndices + views materializadas

---

### ADR-005: Estado Global - TanStack Query

**Status**: ‚úÖ Aprovado  
**Decis√£o**: TanStack Query (server state) + React Context (UI state)

**Justificativa**:
- Cache autom√°tico, stale/refetch, otimista
- Separa server state (lancamentos) de UI state (modal)
- Zero prop drilling

---

### ADR-006: Testes - Vitest + Playwright

**Status**: ‚úÖ Aprovado  
**Decis√£o**: Vitest (unit/integration) + Playwright (E2E)

**Justificativa**:
- Vitest = 5-10√ó mais r√°pido que Jest (ESM nativo)
- Playwright = multi-browser, stable
- Ambos TypeScript-first

**Cobertura Alvo**: Unit 70%, Integration 80%, E2E 90% (happy paths)

---

### ADR-007: Deployment - Vercel + Supabase

**Status**: ‚úÖ Aprovado  
**Decis√£o**: Vercel (frontend) + Supabase (backend)

**Justificativa**:
- Vercel = especialista em Next.js
- Edge network global (< 100ms)
- Preview deploys autom√°ticos
- $20/m√™s at√© 100k requests

---

## 4) Modelo de Dados

### 4.1 Enums

```sql
CREATE TYPE tipo_conta AS ENUM ('bancaria', 'caixa', 'investimento');
CREATE TYPE tipo_lancamento AS ENUM ('pagar', 'receber');
CREATE TYPE status_parcela AS ENUM ('previsto', 'vencido', 'pago', 'parcial', 'cancelado');
CREATE TYPE origem_lanc AS ENUM ('manual', 'import_csv', 'api', 'sistema', 'conciliacao');
CREATE TYPE direcao_pix AS ENUM ('in', 'out');
CREATE TYPE status_pix AS ENUM ('criado', 'liquidado', 'cancelado', 'estornado');
CREATE TYPE papel_usuario AS ENUM ('admin', 'supervisor', 'financeiro', 'gestor_loja', 'vendedor', 'leitor');
CREATE TYPE status_conciliacao AS ENUM ('pendente', 'aprovado', 'rejeitado');
CREATE TYPE tipo_contrato AS ENUM ('aluguel', 'franquia', 'servico', 'fornecedor');
```

### 4.2 Tabelas Principais (Core MVP)

```sql
-- ORGANIZA√á√ÉO
CREATE TABLE lojas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL,
  razao_social TEXT,
  cnpj TEXT UNIQUE,
  endereco JSONB,
  status BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE usuarios (
  id UUID PRIMARY KEY, -- auth.users.id
  email TEXT UNIQUE NOT NULL,
  nome TEXT NOT NULL,
  papel papel_usuario NOT NULL DEFAULT 'leitor',
  loja_ids UUID[] DEFAULT '{}', -- multi-tenant
  ativo BOOLEAN DEFAULT TRUE,
  ultimo_acesso TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ESTRUTURA FINANCEIRA
CREATE TABLE contas_financeiras (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID NOT NULL REFERENCES lojas(id) ON DELETE CASCADE,
  tipo tipo_conta NOT NULL,
  banco TEXT,
  agencia TEXT,
  numero TEXT,
  apelido TEXT NOT NULL,
  saldo_inicial NUMERIC(14,2) DEFAULT 0,
  ativa BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(loja_id, apelido)
);

CREATE TABLE plano_contas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  classe TEXT NOT NULL CHECK (classe IN ('receita','cmv','despesa','impostos','outros')),
  grupo TEXT NOT NULL,
  subgrupo TEXT,
  codigo TEXT UNIQUE NOT NULL,
  descricao TEXT NOT NULL,
  ativo BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE centros_custos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID NOT NULL REFERENCES lojas(id) ON DELETE CASCADE,
  nome TEXT NOT NULL,
  descricao TEXT,
  ativo BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(loja_id, nome)
);

CREATE TABLE fornecedores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL,
  tipo TEXT CHECK (tipo IN ('pessoa_fisica','pessoa_juridica')),
  doc TEXT,
  email TEXT,
  telefone TEXT,
  endereco JSONB,
  contato JSONB,
  observacoes TEXT,
  ativo BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- TRANSA√á√ïES FINANCEIRAS
CREATE TABLE lancamentos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID NOT NULL REFERENCES lojas(id) ON DELETE CASCADE,
  tipo tipo_lancamento NOT NULL,
  plano_id UUID REFERENCES plano_contas(id),
  centro_id UUID REFERENCES centros_custos(id),
  fornecedor_id UUID REFERENCES fornecedores(id),
  descricao TEXT NOT NULL,
  competencia DATE NOT NULL,
  valor_total NUMERIC(14,2) NOT NULL CHECK (valor_total > 0),
  num_parcelas INT NOT NULL DEFAULT 1 CHECK (num_parcelas > 0),
  origem origem_lanc DEFAULT 'manual',
  anexos TEXT[] DEFAULT '{}',
  observacoes TEXT,
  user_id UUID REFERENCES usuarios(id),
  aprovado_por UUID REFERENCES usuarios(id),
  aprovado_em TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE parcelas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  lancamento_id UUID NOT NULL REFERENCES lancamentos(id) ON DELETE CASCADE,
  parcela INT NOT NULL CHECK (parcela > 0),
  vencimento DATE NOT NULL,
  valor NUMERIC(14,2) NOT NULL CHECK (valor > 0),
  juros NUMERIC(14,2) DEFAULT 0,
  desconto NUMERIC(14,2) DEFAULT 0,
  valor_pago NUMERIC(14,2),
  status status_parcela NOT NULL DEFAULT 'previsto',
  pagamento_em TIMESTAMPTZ,
  conta_id UUID REFERENCES contas_financeiras(id),
  forma TEXT,
  comprovante TEXT,
  observacao TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(lancamento_id, parcela)
);

-- CONCILIA√á√ÉO
CREATE TABLE extratos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conta_id UUID NOT NULL REFERENCES contas_financeiras(id) ON DELETE CASCADE,
  data TIMESTAMPTZ NOT NULL,
  historico TEXT NOT NULL,
  valor NUMERIC(14,2) NOT NULL,
  saldo_apos NUMERIC(14,2),
  doc_ref TEXT,
  origem TEXT NOT NULL,
  hash_duplo TEXT,
  processado BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(conta_id, hash_duplo)
);

CREATE TABLE conciliacoes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  extrato_id UUID NOT NULL REFERENCES extratos(id) ON DELETE CASCADE,
  parcela_id UUID REFERENCES parcelas(id) ON DELETE CASCADE,
  regra TEXT NOT NULL,
  confianca NUMERIC(5,2) NOT NULL CHECK (confianca BETWEEN 0 AND 100),
  status status_conciliacao NOT NULL DEFAULT 'pendente',
  aprovado_por UUID REFERENCES usuarios(id),
  aprovado_em TIMESTAMPTZ,
  observacoes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(extrato_id, parcela_id)
);

-- MEIOS DE PAGAMENTO
CREATE TABLE pix_transacoes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID NOT NULL REFERENCES lojas(id) ON DELETE CASCADE,
  txid TEXT UNIQUE,
  e2eid TEXT UNIQUE,
  chave TEXT NOT NULL,
  valor NUMERIC(14,2) NOT NULL,
  direcao direcao_pix NOT NULL,
  status status_pix NOT NULL,
  pagador_nome TEXT,
  pagador_doc TEXT,
  criado_em TIMESTAMPTZ NOT NULL,
  liquidado_em TIMESTAMPTZ,
  provider TEXT NOT NULL,
  webhook_raw JSONB,
  parcela_id UUID REFERENCES parcelas(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE cartao_transacoes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID NOT NULL REFERENCES lojas(id) ON DELETE CASCADE,
  adquirente TEXT NOT NULL,
  bandeira TEXT NOT NULL,
  nsu TEXT UNIQUE NOT NULL,
  autorizacao TEXT,
  data_venda TIMESTAMPTZ NOT NULL,
  parcelas INT NOT NULL DEFAULT 1,
  bruto NUMERIC(14,2) NOT NULL,
  taxa_percentual NUMERIC(6,4) NOT NULL,
  taxa_fixa NUMERIC(8,2) DEFAULT 0,
  liquido NUMERIC(14,2) NOT NULL,
  previsto_em DATE NOT NULL,
  liquidado_em DATE,
  parcela_id UUID REFERENCES parcelas(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- CONTRATOS
CREATE TABLE contratos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID NOT NULL REFERENCES lojas(id) ON DELETE CASCADE,
  tipo tipo_contrato NOT NULL,
  fornecedor_id UUID REFERENCES fornecedores(id),
  descricao TEXT NOT NULL,
  valor_base NUMERIC(14,2) NOT NULL,
  indice_reajuste TEXT,
  data_base DATE NOT NULL,
  percentual NUMERIC(6,4),
  vencimento_dia INT CHECK (vencimento_dia BETWEEN 1 AND 31),
  plano_id UUID REFERENCES plano_contas(id),
  centro_id UUID REFERENCES centros_custos(id),
  arquivo TEXT,
  ativo BOOLEAN DEFAULT TRUE,
  inicio_vigencia DATE NOT NULL,
  fim_vigencia DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- VENDAS (opcional - fase 2)
CREATE TABLE vendedores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID NOT NULL REFERENCES lojas(id) ON DELETE CASCADE,
  usuario_id UUID REFERENCES usuarios(id),
  nome TEXT NOT NULL,
  cpf TEXT UNIQUE,
  nivel TEXT,
  ativo BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE vendas_resumo (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID NOT NULL REFERENCES lojas(id) ON DELETE CASCADE,
  data DATE NOT NULL,
  categoria TEXT NOT NULL,
  bruto NUMERIC(14,2) NOT NULL,
  descontos NUMERIC(14,2) DEFAULT 0,
  custo NUMERIC(14,2),
  vendedor_id UUID REFERENCES vendedores(id),
  meio_pgto TEXT,
  origem TEXT DEFAULT 'import_csv',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(loja_id, data, categoria, vendedor_id, meio_pgto)
);

-- AUDITORIA & OBSERVABILIDADE
CREATE TABLE auditoria_financeira (
  id BIGSERIAL PRIMARY KEY,
  entidade TEXT NOT NULL,
  entidade_id UUID NOT NULL,
  acao TEXT NOT NULL,
  antes JSONB,
  depois JSONB,
  user_id UUID REFERENCES usuarios(id),
  ip INET,
  user_agent TEXT,
  correlation_id TEXT,
  em TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE event_bus (
  id BIGSERIAL PRIMARY KEY,
  tipo TEXT NOT NULL,
  payload JSONB NOT NULL,
  criado_em TIMESTAMPTZ DEFAULT NOW(),
  processado_em TIMESTAMPTZ,
  erro TEXT
);
```

### 4.3 √çndices Cr√≠ticos

```sql
-- Performance em queries de dashboard
CREATE INDEX idx_parcelas_status_vencimento ON parcelas (status, vencimento) 
  WHERE status IN ('previsto', 'vencido');
CREATE INDEX idx_parcelas_lancamento ON parcelas (lancamento_id);

CREATE INDEX idx_extratos_conta_data ON extratos (conta_id, data DESC);
CREATE INDEX idx_extratos_processado ON extratos (processado) WHERE processado = FALSE;
CREATE INDEX idx_extratos_hash ON extratos USING HASH(hash_duplo);

CREATE INDEX idx_conciliacoes_status ON conciliacoes (status) WHERE status = 'pendente';
CREATE INDEX idx_conciliacoes_parcela ON conciliacoes (parcela_id);

CREATE INDEX idx_pix_loja_status ON pix_transacoes (loja_id, status, direcao);
CREATE INDEX idx_cartao_loja_previsto ON cartao_transacoes (loja_id, previsto_em);

CREATE INDEX idx_lancamentos_loja_comp ON lancamentos (loja_id, competencia DESC, tipo);
CREATE INDEX idx_lancamentos_descricao_fts ON lancamentos 
  USING GIN(to_tsvector('portuguese', descricao));

CREATE INDEX idx_auditoria_user_em ON auditoria_financeira (user_id, em DESC);
CREATE INDEX idx_auditoria_entidade ON auditoria_financeira (entidade, entidade_id);

CREATE INDEX idx_event_bus_pendente ON event_bus (criado_em) WHERE processado_em IS NULL;
```

### 4.4 Row Level Security (RLS) - Exemplo

```sql
-- Fun√ß√£o helper
CREATE OR REPLACE FUNCTION tem_acesso_loja(loja UUID)
RETURNS BOOLEAN LANGUAGE SQL STABLE AS $$
  SELECT EXISTS (
    SELECT 1 FROM usuarios
    WHERE id = auth.uid()
      AND (papel = 'admin' OR loja = ANY(loja_ids))
      AND ativo = TRUE
  );
$$;

-- Pol√≠tica em lan√ßamentos
ALTER TABLE lancamentos ENABLE ROW LEVEL SECURITY;

CREATE POLICY p_lancamentos_select ON lancamentos
  FOR SELECT USING (tem_acesso_loja(loja_id));

CREATE POLICY p_lancamentos_insert ON lancamentos
  FOR INSERT WITH CHECK (
    tem_acesso_loja(loja_id) AND
    EXISTS (
      SELECT 1 FROM usuarios
      WHERE id = auth.uid()
        AND papel IN ('admin','supervisor','financeiro','gestor_loja')
    )
  );

-- (Repetir para todas as tabelas cr√≠ticas)
```

### 4.5 Views Materializadas

```sql
-- Fluxo de Caixa Projetado
CREATE VIEW vw_fluxo_caixa AS
SELECT p.vencimento::DATE AS dia,
       l.loja_id,
       SUM(CASE WHEN l.tipo='receber' THEN p.valor ELSE 0 END) AS entradas,
       SUM(CASE WHEN l.tipo='pagar' THEN p.valor ELSE 0 END) AS saidas
FROM parcelas p
JOIN lancamentos l ON l.id = p.lancamento_id
WHERE p.status IN ('previsto','vencido')
GROUP BY 1, 2;

-- DRE Mensal
CREATE VIEW vw_dre_mensal AS
SELECT DATE_TRUNC('month', vr.data) AS mes,
       vr.loja_id,
       SUM(vr.bruto - vr.descontos) AS receita_liquida,
       SUM(vr.custo) AS cmv,
       SUM(vr.bruto - vr.descontos - vr.custo) AS margem_bruta
FROM vendas_resumo vr
GROUP BY 1, 2;

-- Saldos Atualizados (materializada)
CREATE MATERIALIZED VIEW mv_saldos_contas AS
SELECT cf.id AS conta_id,
       cf.loja_id,
       cf.apelido,
       cf.saldo_inicial + COALESCE(SUM(e.valor), 0) AS saldo_atual,
       MAX(e.data) AS ultima_movimentacao
FROM contas_financeiras cf
LEFT JOIN extratos e ON e.conta_id = cf.id
WHERE cf.ativa = TRUE
GROUP BY cf.id, cf.loja_id, cf.apelido, cf.saldo_inicial;

CREATE UNIQUE INDEX ON mv_saldos_contas (conta_id);
```

### 4.6 RPCs Principais

```sql
-- Previs√£o de Caixa (m√©dia m√≥vel)
CREATE OR REPLACE FUNCTION rpc_prever_caixa(
  p_loja_id UUID,
  p_dias INT DEFAULT 30
)
RETURNS TABLE(dia DATE, entradas_esperadas NUMERIC, saidas_esperadas NUMERIC)
LANGUAGE SQL STABLE AS $$
  WITH base AS (
    SELECT p.vencimento AS dia,
           SUM(CASE WHEN l.tipo='receber' THEN p.valor ELSE -p.valor END) AS neto
    FROM parcelas p
    JOIN lancamentos l ON l.id = p.lancamento_id
    WHERE l.loja_id = p_loja_id AND p.status = 'pago'
      AND p.pagamento_em >= NOW() - INTERVAL '60 days'
    GROUP BY 1
  ),
  media AS (
    SELECT AVG(CASE WHEN neto > 0 THEN neto ELSE 0 END) AS media_entradas,
           AVG(CASE WHEN neto < 0 THEN ABS(neto) ELSE 0 END) AS media_saidas
    FROM base
  )
  SELECT g::DATE,
         (SELECT media_entradas FROM media),
         (SELECT media_saidas FROM media)
  FROM generate_series(NOW()::DATE + 1, NOW()::DATE + p_dias, INTERVAL '1 day') g;
$$;

-- Concilia√ß√£o por doc_ref
CREATE OR REPLACE FUNCTION rpc_conciliar_por_ref(p_doc_ref TEXT)
RETURNS INT LANGUAGE PLPGSQL AS $$
DECLARE v_count INT;
BEGIN
  WITH candidatos AS (
    SELECT e.id AS extrato_id,
           p.id AS parcela_id,
           95.0 AS confianca
    FROM extratos e
    JOIN parcelas p ON p.status IN ('previsto', 'vencido')
      AND ABS(e.valor - p.valor) < (p.valor * 0.05)
    WHERE e.doc_ref = p_doc_ref AND e.processado = FALSE
    ORDER BY ABS(e.valor - p.valor) ASC
    LIMIT 1
  )
  INSERT INTO conciliacoes (extrato_id, parcela_id, regra, confianca)
  SELECT extrato_id, parcela_id, 'DOC_REF_MATCH', confianca
  FROM candidatos
  ON CONFLICT DO NOTHING;
  
  GET DIAGNOSTICS v_count = ROW_COUNT;
  RETURN v_count;
END;
$$;

-- Aplicar reajuste de contrato
CREATE OR REPLACE FUNCTION rpc_reajustar_contrato(
  p_contrato_id UUID,
  p_indice_percentual NUMERIC,
  p_usuario_id UUID
)
RETURNS JSONB LANGUAGE PLPGSQL AS $$
DECLARE
  v_contrato RECORD;
  v_novo_valor NUMERIC;
BEGIN
  SELECT * INTO v_contrato FROM contratos WHERE id = p_contrato_id AND ativo = TRUE;
  
  IF NOT FOUND THEN
    RETURN jsonb_build_object('sucesso', FALSE, 'erro', 'Contrato n√£o encontrado');
  END IF;
  
  v_novo_valor := v_contrato.valor_base * (1 + p_indice_percentual / 100);
  
  UPDATE contratos
  SET valor_base = v_novo_valor,
      data_base = NOW()::DATE,
      updated_at = NOW()
  WHERE id = p_contrato_id;
  
  INSERT INTO auditoria_financeira (entidade, entidade_id, acao, antes, depois, user_id)
  VALUES ('contrato', p_contrato_id, 'reajuste',
          to_jsonb(v_contrato),
          jsonb_build_object('valor_base', v_novo_valor, 'indice', p_indice_percentual),
          p_usuario_id);
  
  RETURN jsonb_build_object(
    'sucesso', TRUE,
    'valor_anterior', v_contrato.valor_base,
    'valor_novo', v_novo_valor,
    'percentual', p_indice_percentual
  );
END;
$$;
```

### 4.7 Triggers

```sql
-- Dedupe de extrato por hash
CREATE OR REPLACE FUNCTION trg_extrato_hash()
RETURNS TRIGGER LANGUAGE PLPGSQL AS $$
BEGIN
  NEW.hash_duplo := ENCODE(
    DIGEST(
      COALESCE(NEW.doc_ref, '') || 
      NEW.data::TEXT || 
      NEW.valor::TEXT ||
      NEW.historico,
      'sha256'
    ),
    'hex'
  );
  RETURN NEW;
END;
$$;

CREATE TRIGGER t_extrato_hash 
  BEFORE INSERT ON extratos
  FOR EACH ROW 
  EXECUTE FUNCTION trg_extrato_hash();

-- Atualizar updated_at
CREATE OR REPLACE FUNCTION trg_updated_at()
RETURNS TRIGGER LANGUAGE PLPGSQL AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$;

CREATE TRIGGER t_lancamentos_updated 
  BEFORE UPDATE ON lancamentos
  FOR EACH ROW 
  EXECUTE FUNCTION trg_updated_at();

-- Auditoria autom√°tica
CREATE OR REPLACE FUNCTION trg_auditoria()
RETURNS TRIGGER LANGUAGE PLPGSQL AS $$
DECLARE v_user_id UUID;
BEGIN
  v_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::UUID);
  
  IF TG_OP = 'DELETE' THEN
    INSERT INTO auditoria_financeira (entidade, entidade_id, acao, antes, user_id)
    VALUES (TG_TABLE_NAME, OLD.id, 'delete', to_jsonb(OLD), v_user_id);
    RETURN OLD;
  ELSIF TG_OP = 'UPDATE' THEN
    INSERT INTO auditoria_financeira (entidade, entidade_id, acao, antes, depois, user_id)
    VALUES (TG_TABLE_NAME, NEW.id, 'update', to_jsonb(OLD), to_jsonb(NEW), v_user_id);
    RETURN NEW;
  ELSIF TG_OP = 'INSERT' THEN
    INSERT INTO auditoria_financeira (entidade, entidade_id, acao, depois, user_id)
    VALUES (TG_TABLE_NAME, NEW.id, 'insert', to_jsonb(NEW), v_user_id);
    RETURN NEW;
  END IF;
END;
$$;

CREATE TRIGGER t_audit_lancamentos 
  AFTER INSERT OR UPDATE OR DELETE ON lancamentos
  FOR EACH ROW EXECUTE FUNCTION trg_auditoria();
```

---

## 5) Dom√≠nios Funcionais

### 5.1 Dashboard Executivo

**Objetivo**: Vis√£o 360¬∞ em < 5 segundos

**Componentes**:
- Saldo consolidado + por conta
- Agenda de vencimentos D+7 (pagar/receber)
- Dias de caixa dispon√≠vel (cores: verde >15d, amarelo 8-15d, vermelho <8d)
- Gr√°fico de fluxo 30 dias (realizado + previsto)
- KPIs: Margem l√≠quida, ticket m√©dio, inadimpl√™ncia %
- Alertas IA: "Taxa Stone acima da m√©dia" / "Caixa cr√≠tico em 5 dias"
- Seletor multi-loja (consolidado ou individual)

**Regras de Neg√≥cio**:
- Saldo = Saldo inicial + (Entradas realizadas - Sa√≠das realizadas)
- Dias de caixa = Saldo atual / M√©dia di√°ria de sa√≠das (√∫ltimos 30d)

### 5.2 Contas a Pagar / Receber (AP/AR)

**Funcionalidades**:
- Grid com filtros avan√ßados (loja, status, plano, centro, per√≠odo)
- Cria√ß√£o r√°pida com parcelamento inteligente
- Upload de anexos (NF, contrato, boleto)
- Split por centro de custo (ex: 50% vendas, 50% admin)
- A√ß√µes em lote: baixar, reagendar, renegociar
- Workflow: Rascunho ‚Üí Aprovado ‚Üí Pago/Recebido

**Parcelamento Inteligente**:
- Entrada + N parcelas (ex: R$ 1.000 = R$ 400 entrada + 3x R$ 200)
- Vencimentos personalizados
- Juros simples ou compostos (manual)

**Valida√ß√µes**:
- Plano de contas obrigat√≥rio para DRE
- Centro de custo obrigat√≥rio se loja tem >1 CC
- Fornecedor obrigat√≥rio em "Pagar" > R$ 1.000

### 5.3 Fluxo de Caixa & Proje√ß√µes

**Visualiza√ß√µes**:
- Calend√°rio mensal (dia a dia): barras de entrada/sa√≠da
- Curva acumulada (realizado vs. previsto)
- Cen√°rios what-if: "E se atrasar 50% dos recebimentos?"
- Simulador de antecipa√ß√£o: custo vs. benef√≠cio

**Previs√£o (Motor v1)**:
- M√©dia m√≥vel ponderada (√∫ltimos 60 dias)
- Ajuste sazonal (feriados, campanhas)
- Recorr√™ncias (aluguel, franquia, folha)
- Margem de erro: MAPE < 20% (meta 15% em 60d)

**Alertas Proativos**:
- Caixa insuficiente em D+X
- Concentra√ß√£o de vencimentos
- Oportunidade de antecipa√ß√£o

### 5.4 DRE Gerencial

**Estrutura Padr√£o √ìticas**:
```
RECEITA BRUTA
  Venda de Arma√ß√µes
  Venda de Lentes (Monofocais/Multifocais/Progressivas)
  Servi√ßos (Consultas/Ajustes/Reparos)
(-) Descontos
(-) Impostos sobre vendas
= RECEITA L√çQUIDA

(-) CMV
  Compra de Arma√ß√µes
  Compra de Lentes
  Frete de Compras
= MARGEM BRUTA

(-) DESPESAS OPERACIONAIS
  Pessoal (sal√°rios, comiss√µes, encargos)
  Aluguel
  Marketing
  Administrativas
  Franquia (se aplic√°vel)
= EBITDA

(-) Deprecia√ß√£o/Amortiza√ß√£o
(-) Juros
= LUCRO L√çQUIDO
```

**Funcionalidades**:
- Vis√£o mensal, trimestral, anual
- Comparativo: m√™s vs. m√™s anterior, m√™s vs. mesmo m√™s ano anterior
- Drill-down: clica em "Aluguel" ‚Üí v√™ todas as parcelas
- Consolidado + individual por loja
- Export Excel formatado

### 5.5 Contratos e Obriga√ß√µes Recorrentes

**Tipos de Contrato**:
1. **Aluguel**: Valor fixo, dia fixo, reajuste anual (IGPM/IPCA)
2. **Franquia**: Percentual sobre faturamento bruto (ex: 5%)
3. **Servi√ßos**: Limpeza, seguran√ßa, contabilidade (valor fixo)

**Automa√ß√£o**:
- pg_cron di√°rio: gera lan√ßamento "Pagar" no dia D-5 do vencimento
- Status inicial: "Rascunho" (financeiro revisa e aprova)
- Reajuste: job anual verifica anivers√°rio ‚Üí aplica √≠ndice ‚Üí gera alerta

**Reajuste de Aluguel (exemplo)**:
```
Contrato: R$ 3.000 (base: jan/2024, √≠ndice: IGPM)
Anivers√°rio: jan/2025
IGPM acumulado: 4,35%
Novo valor: R$ 3.000 √ó 1,0435 = R$ 3.130,50
Sistema: Cria rascunho + notifica gestor
```

### 5.6 Comiss√µes e Metas (Fase 2)

**Estrutura de Regras**:
```json
{
  "vendedor": "Jo√£o Silva",
  "loja": "Mau√°",
  "periodo": "2025-09",
  "regras": [
    {"categoria": "armacao", "percentual": 0.03},
    {"categoria": "lente", "percentual": 0.02},
    {
      "categoria": "servico",
      "tipo": "faixa",
      "faixas": [
        {"min": 0, "max": 1000, "percentual": 0.05},
        {"min": 1001, "max": 3000, "percentual": 0.08},
        {"min": 3001, "max": 999999, "percentual": 0.10}
      ]
    }
  ]
}
```

### 5.7 BI & Copiloto (IA)

**Q&A Natural**:
```
Usu√°rio: "Qual a margem bruta da loja Mau√° em agosto?"
Copiloto: 
  1. Identifica: loja=Mau√°, per√≠odo=ago/25, m√©trica=margem_bruta
  2. Gera SQL: SELECT ... FROM vw_dre_mensal WHERE ...
  3. Responde: "A margem bruta foi R$ 45.320 (38% da receita)"
```

**Seguran√ßa**:
- Whitelist de views: apenas `vw_*`
- RLS aplicado: vendedor n√£o v√™ custo
- Logs de todas as perguntas

**Insights Proativos**:
- "Taxa Visa aumentou 0,3% vs. m√™s passado"
- "Inadimpl√™ncia 15% acima da m√©dia"
- "Dias de caixa cair√£o para 8 em 12 dias"

**Detec√ß√£o de Anomalias**:
- Isolation Forest/Z-score
- Casos: despesas 2√ó acima da m√©dia
- Notifica√ß√£o: alerta no dashboard + email

### 5.8 Admin & Governan√ßa

**M√≥dulos**:
1. Usu√°rios & Permiss√µes (CRUD + matriz de pap√©is)
2. Plano de Contas (hierarquia customiz√°vel)
3. Centros de Custo (ativo/inativo)
4. Integra√ß√µes (tokens API, mapeamento CSV)
5. Auditoria (filtros por usu√°rio/entidade/per√≠odo)

**Matriz de Permiss√µes**:

| Recurso | admin | supervisor | financeiro | gestor_loja | vendedor | leitor |
|---------|:-----:|:----------:|:----------:|:-----------:|:--------:|:------:|
| Dashboard | R/W | R | R | R | R | R |
| Lan√ßamentos | R/W | R/W | R/W | R/W | R | R |
| Concilia√ß√£o | R/W | R/W | R/W | R | - | - |
| Fluxo & DRE | R/W | R | R | R | - | R |
| Contratos | R/W | R | R | R | - | - |
| Comiss√µes | R/W | R/W | R | R | R | - |
| Config | R/W | R | R | - | - | - |

---

## 6) Concilia√ß√£o Banc√°ria

### 6.1 Arquitetura do Motor

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. INGEST√ÉO & NORMALIZA√á√ÉO               ‚îÇ
‚îÇ  CSV Bank/API Pix ‚Üí extratos              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. MOTOR DE PAREAMENTO                   ‚îÇ
‚îÇ  ‚îú‚îÄ Camada 1: Regras Determin√≠sticas 70% ‚îÇ
‚îÇ  ‚îú‚îÄ Camada 2: IA Score 0-100 (20%)        ‚îÇ
‚îÇ  ‚îî‚îÄ Camada 3: Manual Assistido (10%)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. APROVA√á√ÉO & EFEITOS                   ‚îÇ
‚îÇ  parcelas.status='pago' + event_bus       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.2 Regras Determin√≠sticas

**Regra 1: DOC_REF_MATCH (95% confian√ßa)**
- `extrato.doc_ref` = `parcela.id` OU
- `extrato.doc_ref` = `pix_transacoes.e2eid` OU
- `extrato.doc_ref` = `cartao_transacoes.nsu`

**Regra 2: PIX_TXID (98% confian√ßa)**
- `extrato.doc_ref` casa com `pix_transacoes.txid`

**Regra 3: VALUE_DATE_NEAR (80% confian√ßa)**
- `|extrato.valor - parcela.valor|` < 2%
- `|extrato.data - parcela.vencimento|` ‚â§ 2 dias

**Regra 4: CARTAO_NSU (90% confian√ßa)**
- `extrato.doc_ref` = `cartao_transacoes.nsu`
- Considera taxa de adquirente (valor l√≠quido)

### 6.3 IA de Pareamento

**Features**:
- `valor_diff_pct`: diferen√ßa percentual de valor
- `dias_diff`: diferen√ßa em dias entre data e vencimento
- `n_gramas`: similaridade textual do hist√≥rico
- `hora_dia`, `dia_semana`: padr√µes temporais
- `loja_id`: padr√µes espec√≠ficos por loja

**Modelo**: XGBoost ou Random Forest (leve, roda no Edge)

**Score**: 0-100 ‚Üí se >70, sugere para aprova√ß√£o

**Feedback Loop**: usu√°rio confirma/rejeita ‚Üí retreino semanal

### 6.4 Parsers por Banco

```typescript
// lib/parsers/banco-do-brasil.ts
export function parseBancoDoBrasil(csvText: string) {
  const result = Papa.parse(csvText, {
    header: true,
    skipEmptyLines: true,
    transformHeader: (h) => h.trim().toLowerCase()
  });

  return result.data.map((row: any) => ({
    data: parseDate(row.data), // dd/mm/yyyy ‚Üí ISO
    historico: row.hist√≥rico || row.descricao,
    valor: parseFloat(row.valor.replace('.', '').replace(',', '.')),
    doc_ref: row.documento || null,
    origem: 'csv_bb'
  }));
}
```

### 6.5 Dicion√°rio de Normaliza√ß√£o

```sql
CREATE TABLE dicionario_historico (
  banco TEXT NOT NULL,
  termo_original TEXT NOT NULL,
  termo_normalizado TEXT NOT NULL,
  PRIMARY KEY (banco, termo_original)
);

INSERT INTO dicionario_historico VALUES
  ('bb', 'PIX RECEB', 'PIX_IN'),
  ('bb', 'PIX ENVIADO', 'PIX_OUT'),
  ('bb', 'TED ENVIADA', 'TED_OUT'),
  ('itau', 'Pix recebido', 'PIX_IN');
```

---

## 7) IA & Business Intelligence

### 7.1 Forecast de Caixa

**Motor v1 (MVP)**: M√©dia m√≥vel ponderada
- √öltimos 60 dias
- Ajuste sazonal (feriados cadastrados)
- Recorr√™ncias (aluguel, franquia)
- MAPE esperado: 20-25%

**Motor v2 (P√≥s-MVP)**: Prophet/ARIMA
- Sazonalidade complexa (Black Friday, Dia das M√£es)
- Features: dias √∫teis, campanhas
- Integra√ß√£o com metas de vendas
- MAPE esperado: 12-18%

### 7.2 Detec√ß√£o de Anomalias

**Algoritmo**: Isolation Forest ou Z-score

**Casos**:
- Despesas 2√ó acima da m√©dia
- Vendas 50% abaixo do esperado
- Taxas de adquirente acima do P95

**Notifica√ß√£o**: Alerta no dashboard + email

### 7.3 Recomenda√ß√µes Acion√°veis

```
Insight: "Taxas de cart√£o R$ 1.200 acima do esperado"
A√ß√£o: "Migrar 30% das vendas para Pix (economia ~R$ 800)"
Justificativa: "Taxa m√©dia cart√£o: 3,2% vs. Pix: 0,99%"
```

### 7.4 Q&A Natural (LLM)

**Implementa√ß√£o**:
- LLM: Claude/GPT via API
- Function calling: traduz pergunta ‚Üí SQL
- Whitelist: apenas views `vw_*`
- Logging: todas as perguntas em `auditoria_financeira`

**Seguran√ßa**:
- RLS aplicado (vendedor n√£o v√™ custo)
- Rate limiting (10 perguntas/min por usu√°rio)
- Sanitiza√ß√£o de entrada

---

## 8) Integra√ß√µes

### 8.1 CSV - Padr√£o PULSO

**Extratos Banc√°rios**:
```csv
conta_apelido,data_iso,historico,valor,saldo_apos,doc_ref
CAIXA_MAUA,2025-09-04T14:22:00,PIX RECEBIDO CLIENTE X,350.00,20450.22,E2E123...
```

**Lan√ßamentos**:
```csv
loja,tipo,plano_codigo,centro_nome,descricao,competencia,vencimento,valor_total,fornecedor,num_parcelas
MAUA,pagar,DESP.ALG,ADM,Aluguel Set/25,2025-09-01,2025-09-10,3402.12,Imobiliaria Z,1
```

### 8.2 Webhooks Pix (Edge Function)

```typescript
// supabase/functions/webhook-pix/index.ts
serve(async (req) => {
  const signature = req.headers.get('X-Signature');
  if (!validateSignature(signature, await req.text())) {
    return new Response('Unauthorized', { status: 401 });
  }

  const payload = await req.json();
  
  if (payload.event === 'pix.received') {
    await supabase.from('pix_transacoes').insert({
      loja_id: mapAccountToLoja(payload.account_id),
      txid: payload.txid,
      e2eid: payload.endToEndId,
      valor: payload.amount,
      direcao: 'in',
      status: 'liquidado',
      liquidado_em: payload.timestamp,
      provider: 'stripe',
      webhook_raw: payload
    });

    // Tentar pareamento autom√°tico
    await supabase.rpc('rpc_conciliar_por_ref', {
      p_doc_ref: payload.endToEndId
    });
  }

  return new Response('OK');
});
```

### 8.3 Adquirentes (CSV ‚Üí API futura)

**Fase 1**: CSV manual
**Fase 2**: API polling (Stone, Cielo, Rede)

```typescript
async function fetchStoneTransacoes(loja_id: string, desde: Date) {
  const response = await fetch('https://api.stone.com.br/v1/transactions', {
    headers: {
      'Authorization': `Bearer ${STONE_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      merchant_id: getMerchantId(loja_id),
      start_date: desde.toISOString()
    })
  });

  const data = await response.json();
  
  return data.transactions.map((t: any) => ({
    loja_id,
    adquirente: 'stone',
    bandeira: t.card_brand,
    nsu: t.nsu,
    data_venda: t.created_at,
    parcelas: t.installments,
    bruto: t.amount,
    taxa_percentual: t.mdr_rate,
    liquido: t.net_amount,
    previsto_em: t.settlement_date
  }));
}
```

---

## 9) Seguran√ßa e Compliance

### 9.1 Camadas de Seguran√ßa

```
1. Autentica√ß√£o (Supabase Auth)
   ‚îú‚îÄ Email/Password + MFA (TOTP)
   ‚îî‚îÄ JWT com expira√ß√£o 1h

2. Autoriza√ß√£o (RLS)
   ‚îú‚îÄ Row-level por loja
   ‚îî‚îÄ Papel (admin/financeiro/vendedor)

3. Valida√ß√£o de Entrada
   ‚îú‚îÄ Zod (frontend + Edge)
   ‚îî‚îÄ CHECK constraints (banco)

4. Criptografia
   ‚îú‚îÄ TLS 1.3 (HTTPS)
   ‚îú‚îÄ Tokens externos (AES-256)
   ‚îî‚îÄ Anexos (Storage privado)

5. Auditoria
   ‚îú‚îÄ Logs de acesso (IP + User-Agent)
   ‚îú‚îÄ Trilha de altera√ß√µes
   ‚îî‚îÄ Reten√ß√£o 90 dias

6. Rate Limiting
   ‚îú‚îÄ Supabase: 100 req/s por IP
   ‚îî‚îÄ Edge Functions: 10 req/min por user
```

### 9.2 Gerenciamento de Segredos

**Supabase Vault**:
```sql
-- Armazenar API keys criptografadas
INSERT INTO vault.secrets (secret, name, description)
VALUES ('sk_live_abc123...', 'pix_provider_key', 'Chave API Pix');

-- Usar em Edge Function
CREATE OR REPLACE FUNCTION get_pix_key()
RETURNS TEXT LANGUAGE PLPGSQL SECURITY DEFINER AS $$
BEGIN
  RETURN vault.decrypt_secret(
    (SELECT secret FROM vault.secrets WHERE name = 'pix_provider_key')
  );
END;
$$;
```

**Rota√ß√£o de Chaves**: Trimestral

### 9.3 Compliance LGPD

**Dados Pessoais**:
- CPF/CNPJ de fornecedores (essencial para opera√ß√£o)
- Email/telefone de usu√°rios (Supabase Auth)

**Direitos do Titular**:
1. **Acesso**: export JSON de todos os dados
2. **Corre√ß√£o**: CRUD completo via UI
3. **Exclus√£o**: soft delete (ativo=false) + hard delete ap√≥s 90 dias
4. **Portabilidade**: export CSV/JSON

**Consentimento**:
- Aceite de termos no primeiro login
- Registro em `auditoria_financeira`

---

## 10) Extens√µes v2.0

### 10.1 Open Finance ‚Äî Agrega√ß√£o Autom√°tica

**Objetivo**: Eliminar CSV, sincronizar extratos automaticamente

**Novas Tabelas**:
```sql
CREATE TABLE openfinance_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID REFERENCES lojas(id),
  provider TEXT NOT NULL, -- 'pluggy'|'belvo'
  access_token_enc TEXT NOT NULL,
  consent_id TEXT,
  status TEXT DEFAULT 'ativo',
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE bank_accounts_external (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  connection_id UUID REFERENCES openfinance_connections(id),
  external_id TEXT,
  apelido TEXT,
  banco TEXT,
  last_sync TIMESTAMPTZ
);
```

**Mapeamento**:
```sql
CREATE OR REPLACE FUNCTION rpc_sync_openfinance(
  account UUID,
  conta_destino UUID
)
RETURNS INT AS $$
  INSERT INTO extratos (conta_id, data, historico, valor, origem, hash_duplo)
  SELECT conta_destino, occurred_at, description, amount, 'api_openfinance', hash_duplo
  FROM bank_transactions_external
  WHERE account_id = account
  ON CONFLICT (hash_duplo) DO NOTHING;
$$;
```

**Jobs**: `*/15 * * * *` ‚Üí Pull de cada provider ativo

### 10.2 Pix Program√°vel (Pix Out)

**Objetivo**: Automatizar pagamentos a fornecedores

**Novas Tabelas**:
```sql
CREATE TABLE pix_pagamentos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID REFERENCES lojas(id),
  fornecedor_id UUID REFERENCES fornecedores(id),
  chave_pix TEXT NOT NULL,
  valor NUMERIC(14,2) NOT NULL,
  agendado_em TIMESTAMPTZ,
  status TEXT DEFAULT 'rascunho', -- rascunho/aprovacao/agendado/enviado/confirmado
  provider_txid TEXT,
  criado_por UUID REFERENCES usuarios(id)
);

CREATE TABLE payment_approvals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pagamento_id UUID REFERENCES pix_pagamentos(id),
  aprovado_por UUID REFERENCES usuarios(id),
  aprovado_em TIMESTAMPTZ,
  status TEXT -- aprovado/reprovado
);
```

**Fluxo**:
1. Seleciona `parcelas` vencendo ‚Üí "Gerar Pix Pagamento"
2. Workflow dupla aprova√ß√£o (>=2 aprovadores)
3. Edge Function cria ordem no provider
4. Ao confirmar ‚Üí marca `parcelas.status='pago'`

### 10.3 PULSO Score (0-100)

**Objetivo**: Gamificar sa√∫de financeira

**Componentes e Pesos**:
- **Liquidez (LQ)** ‚Äî dias de caixa (30%)
- **Margem Bruta (MB)** ‚Äî % mensal (25%)
- **Pontualidade (PT)** ‚Äî % parcelas pagas em dia (20%)
- **Previsibilidade (PV)** ‚Äî MAPE invertido (15%)
- **Concilia√ß√£o (CC)** ‚Äî % auto-match (10%)

**View**:
```sql
CREATE VIEW vw_pulso_score_mensal AS
WITH base AS (
  SELECT l.id AS loja_id,
         COALESCE((SELECT AVG(dias) FROM vw_dias_de_caixa WHERE loja_id=l.id), 0) AS lq_dias,
         COALESCE((SELECT margem FROM vw_dre_mensal WHERE loja_id=l.id), 0) AS mb,
         -- ... outros componentes
  FROM lojas l
)
SELECT loja_id,
       ROUND(
         (norm_lq(lq_dias)*0.30) + 
         (norm_mb(mb)*0.25) + 
         (norm_pt(pt)*0.20) + 
         (norm_pv(pv)*0.15) + 
         (norm_cc(cc)*0.10),
         2
       ) AS pulso_score
FROM base;
```

**UX**: Card com cor (vermelho <50, amarelo 50-74, verde 75+)

### 10.4 OCR de Comprovantes

**Objetivo**: Reduzir digita√ß√£o manual

**Tabela**:
```sql
CREATE TABLE anexos_processados (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  url TEXT NOT NULL,
  tipo TEXT, -- boleto/comprovante/nf
  extraido JSONB, -- {"valor":..., "vencimento":..., "fornecedor":...}
  confianca NUMERIC(5,2),
  status TEXT DEFAULT 'novo',
  criado_em TIMESTAMPTZ DEFAULT NOW()
);
```

**Pipeline**:
1. Upload ‚Üí event_bus
2. Edge `/ocr/run` chama OCR (Tesseract/Azure)
3. Sugere rascunho de lan√ßamento
4. Usu√°rio confirma/edita

### 10.5 Relat√≥rios Narrativos IA

**Objetivo**: Comunica√ß√£o executiva autom√°tica

**Tabela**:
```sql
CREATE TABLE reports_mensais (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID REFERENCES lojas(id),
  mes DATE NOT NULL,
  resumo_md TEXT, -- markdown gerado por LLM
  gerado_em TIMESTAMPTZ DEFAULT NOW()
);
```

**RPC**: `rpc_gerar_relatorio_mensal(loja_id, mes)`
- Consulta views (DRE, fluxo, score)
- Chama LLM (Claude/GPT)
- Salva `resumo_md`

**Job**: Mensal no dia 1 √†s 7h

### 10.6 Exporta√ß√£o Cont√°bil

**Objetivo**: Integra√ß√£o com escrit√≥rio

**Mapeamento**:
```sql
CREATE TABLE plano_contas_mapeamento (
  conta_id UUID REFERENCES plano_contas(id),
  sistema TEXT, -- 'sped'|'nibo'|'omie'
  codigo_externo TEXT,
  PRIMARY KEY (conta_id, sistema)
);
```

**RPC**: `rpc_export_contabilidade(mes, sistema)`
- Gera CSV/Excel em Storage
- Cron mensal p√≥s-fechamento

### 10.7 Ranking de Adquirentes

**Objetivo**: Otimizar taxas

**View**:
```sql
CREATE VIEW vw_ranking_adquirentes AS
SELECT loja_id,
       adquirente,
       bandeira,
       AVG(taxa_percentual) AS taxa_media,
       AVG(CASE WHEN liquidado_em IS NOT NULL 
           THEN (liquidado_em - previsto_em) 
           ELSE INTERVAL '0 day' END) AS atraso_medio,
       COUNT(*) AS transacoes
FROM cartao_transacoes
GROUP BY 1, 2, 3;
```

**Insight**: Custo efetivo = MDR + (custo antecipa√ß√£o √ó atraso)

### 10.8 Planejamento Semanal Assistido

**Objetivo**: Disciplina de tesouraria

**Tabela**:
```sql
CREATE TABLE planejamento_semanal (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loja_id UUID REFERENCES lojas(id),
  semana DATE NOT NULL, -- segunda-feira
  plano JSONB, -- lista de a√ß√µes
  status TEXT DEFAULT 'gerado',
  criado_em TIMESTAMPTZ DEFAULT NOW()
);
```

**Algoritmo (Edge)**:
1. Proje√ß√£o D+14 + agenda de vencimentos
2. Gera plano (ordem √≥tima de pagamentos)
3. Envia checklist (WhatsApp/dashboard)

---

## 11) Compara√ß√£o Competitiva

| Sistema | Pre√ßo/m√™s | Pontos Fortes | Pontos Fracos | PULSO Vantagem |
|---------|-----------|---------------|---------------|----------------|
| **Conta Azul** | R$ 89-289 | ‚úÖ Maduro, NFe | ‚ùå Gen√©rico, sem multi-loja | ‚úÖ Especializa√ß√£o √≥tica |
| **Omie** | R$ 125-499 | ‚úÖ Completo, API | ‚ùå Complexo | ‚úÖ Simples, onboarding 15min |
| **Granatum** | R$ 69-299 | ‚úÖ Fluxo de caixa | ‚ùå Concilia√ß√£o manual | ‚úÖ Auto-match 70%+ |
| **Nibo** | R$ 119-299 | ‚úÖ PME | ‚ùå Concilia√ß√£o fraca | ‚úÖ IA de pareamento |
| **QuickBooks** | $30-200 | ‚úÖ Gigante | ‚ùå Caro, internacional | ‚úÖ BR-native, Pix |
| **Excel** | R$ 0 | ‚úÖ Gr√°tis | ‚ùå Erro humano | ‚úÖ Automa√ß√£o |

**Nosso Posicionamento**: Alto Valor + Pre√ßo Justo + Especializa√ß√£o

---

## 12) Diagramas

### 12.1 Diagrama ER (Simplificado)

```mermaid
erDiagram
    LOJAS ||--o{ LANCAMENTOS : tem
    LOJAS ||--o{ CONTAS_FINANCEIRAS : possui
    LOJAS ||--o{ CENTROS_CUSTOS : define
    
    LANCAMENTOS ||--o{ PARCELAS : gera
    LANCAMENTOS }o--|| PLANO_CONTAS : classifica
    LANCAMENTOS }o--o| FORNECEDORES : paga
    
    PARCELAS ||--o| CONCILIACOES : pareado_com
    
    CONTAS_FINANCEIRAS ||--o{ EXTRATOS : registra
    EXTRATOS ||--o| CONCILIACOES : concilia_com
```

### 12.2 Fluxo de Concilia√ß√£o

```mermaid
sequenceDiagram
    actor Usuario
    participant UI
    participant API
    participant Parser
    participant DB
    participant Motor
    
    Usuario->>UI: Upload CSV
    UI->>API: POST /api/extratos/import
    API->>Parser: Identificar banco
    Parser->>DB: INSERT extratos (150 linhas)
    DB-->>API: 150 inseridas
    
    API->>Motor: Executar concilia√ß√£o
    Motor->>DB: Buscar parcelas pendentes
    Motor->>Motor: Regras (110 matches)
    Motor->>DB: INSERT conciliacoes
    
    DB-->>UI: WebSocket: atualizar
    UI-->>Usuario: 125/150 auto, 25 pendentes
```

### 12.3 Arquitetura C4 (Containers)

```mermaid
graph TB
    subgraph "Cliente"
        WebApp["Next.js App"]
    end
    
    subgraph "Supabase"
        Auth["Auth (JWT)"]
        DB[(PostgreSQL + RLS)]
        Storage["Storage"]
        Edge["Edge Functions"]
    end
    
    subgraph "Externos"
        PixAPI["Pix Provider"]
        Email["SendGrid"]
    end
    
    WebApp -->|HTTPS/JWT| Auth
    WebApp -->|PostgREST| DB
    WebApp -->|Upload| Storage
    
    Edge -->|Query| DB
    Edge -->|Notify| Email
    
    PixAPI -.->|Webhook| Edge
```

---

## 13) Estrutura do Projeto

```
pulso-finance/
‚îÇ
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ deploy.yml
‚îÇ       ‚îú‚îÄ‚îÄ test.yml
‚îÇ       ‚îî‚îÄ‚îÄ security.yml
‚îÇ
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îî‚îÄ‚îÄ web/
‚îÇ       ‚îú‚îÄ‚îÄ app/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ (dashboard)/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lancamentos/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conciliacao/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fluxo/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dre/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ configuracoes/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ webhooks/pix/route.ts
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ui/              # shadcn/ui
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ lancamentos/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ conciliacao/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ layout/
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ lib/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ supabase/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ parsers/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ validations/
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ styles/
‚îÇ
‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 20250101_initial_schema.sql
‚îÇ   ‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ webhook-pix/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ia-pareamento/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sync-openfinance/
‚îÇ   ‚îî‚îÄ‚îÄ seed.sql
‚îÇ
‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ e2e/
‚îÇ
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ BLUEPRINT.md           # Este documento
‚îÇ   ‚îú‚îÄ‚îÄ ROADMAP.md
‚îÇ   ‚îî‚îÄ‚îÄ adr/
‚îÇ
‚îî‚îÄ‚îÄ package.json
```

---

## 14) Pr√≥ximos Passos

1. **Validar com Stakeholders** (se√ß√£o de Dom√≠nios + Extens√µes v2.0)
2. **Gerar ROADMAP.md** (sprints, timeline, custos)
3. **Setup T√©cnico** (repo + Supabase + Vercel)
4. **Sprint 01 Kickoff** (DDL + CRUD + Dashboard v0)

---

**Vers√£o**: 2.0  
**√öltima Atualiza√ß√£o**: Janeiro 2025  
**Autoria**: Equipe PULSO Finance  
**Licen√ßa**: Confidencial ‚Äî Uso Interno